<!DOCTYPE html>
<html lang="th" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</title>

  <!-- CSRF (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Spring Security) -->
  <meta name="_csrf"        th:content="${_csrf != null ? _csrf.token      : ''}" />
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå -->
  <link rel="stylesheet" th:href="@{/css/main.css}"/>

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (scoped) -->
  <style>
    .booking-detail-wrap { max-width: 900px; margin: 16px auto 96px; padding: 0 16px; }
    .booking-detail-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 16px 0; }
    .booking-detail-title { font-size: clamp(1.2rem, 3vw, 1.6rem); font-weight: 800; }
    .booking-detail-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top: 12px; }
    .booking-detail-item { background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; }
    .booking-detail-label { color: var(--muted); font-size:.9rem; margin-bottom:6px; display:block; }
    .booking-detail-value { font-weight:600; }
    .booking-detail-note { white-space: pre-wrap; }
    .booking-detail-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:16px; }
    @media (max-width: 680px){ .booking-detail-grid { grid-template-columns: 1fr; } }

    /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#f3f4f6; color:#374151; }
    .badge-wait { background:#fff7ed; color:#c2410c; }
    .badge-ok   { background:#e8f5e9; color:#15803d; }
    .badge-cxl  { background:#fee2e2; color:#b91c1c; }

    /* ‡∏õ‡∏∏‡πà‡∏° */
    .btn{ appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; gap:6px }
    .btn-gray{ background:#e5e7eb; color:#111 }
    .btn-primary{ background:#0B63F6; color:#fff }
    .btn-green{ background:#16a34a; color:#fff }
    .btn-red{ background:#ef4444; color:#fff }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); padding:16px; z-index:1000 }
    .modal{ width:100%; max-width:420px; background:#fff; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.15); padding:16px; }
    .modal header{ font-weight:800; margin-bottom:8px; font-size:18px }
    .modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:14px }
    .modal label{ font-size:.9rem; color:#555; display:block; margin:10px 0 4px }
    .modal input{ width:100%; border:1px solid var(--border); border-radius:10px; padding:10px }

    /* Stars (write) */
    .stars{ display:inline-flex; flex-direction:row-reverse; gap:6px }
    .stars input{ display:none }
    .stars label{ font-size:30px; cursor:pointer; color:#ddd; line-height:1; user-select:none; transition:color .12s ease }
    .stars input:checked ~ label, .stars label:hover, .stars label:hover ~ label{ color:#f5b301 }
  </style>
</head>
<body th:with="page='booking'">

<header class="top-nav">
  <a th:href="@{/home}" class="logo">Bar<span class="logo-accent">Ber</span>Shop</a>
  <nav class="nav-center">
    <a th:href="@{/home}">Home</a>
    <a th:href="@{/select_service}" class="active">Booking</a>
  </nav>
</header>

<main class="booking-detail-wrap"
      th:object="${booking}"
      th:attr="data-id=*{id}, data-status=*{status}, data-date=*{date}, data-time=*{time},
               data-service=*{service}, data-barber=*{barber}">
  <!-- ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
  <div class="booking-detail-head">
    <div class="booking-detail-title">
      ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
      <small style="font-weight:700; color:#555;">#<span th:text="*{id}">0</span></small>
    </div>

    <!-- ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div id="statusBadge">
      <span th:if="*{status} == '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'" class="badge badge-wait">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
      <span th:if="*{status} == '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' or *{status} == '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'"
            class="badge badge-ok" th:text="*{status}">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
      <span th:if="*{status} == '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'" class="badge badge-cxl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
      <span th:if="*{status} != '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' and *{status} != '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' and *{status} != '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' and *{status} != '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'"
            class="badge" th:text="*{status}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô</span>
    </div>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏Å -->
  <section class="booking-detail-grid">
    <div class="booking-detail-item">
      <span class="booking-detail-label">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
      <div class="booking-detail-value" th:text="*{service}">‡∏ï‡∏±‡∏î‡∏ú‡∏°</div>
    </div>

    <div class="booking-detail-item">
      <span class="booking-detail-label">‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
      <div class="booking-detail-value" th:text="*{barber}">Barber A</div>
    </div>

    <div class="booking-detail-item">
      <span class="booking-detail-label">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</span>
      <div id="valDate" class="booking-detail-value"
           th:text="${#temporals.format(booking.date, 'dd/MM/yyyy')}">08/08/2025</div>
    </div>

    <div class="booking-detail-item">
      <span class="booking-detail-label">‡πÄ‡∏ß‡∏•‡∏≤</span>
      <!-- time ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô String ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ -->
      <div id="valTime" class="booking-detail-value" th:text="*{time} + ' ‡∏ô.'">14:30 ‡∏ô.</div>
    </div>

    <div class="booking-detail-item">
      <span class="booking-detail-label">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (username)</span>
      <div class="booking-detail-value" th:text="*{username}">guest</div>
    </div>

    <div class="booking-detail-item">
      <span class="booking-detail-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span>
      <div class="booking-detail-value booking-detail-note"
           th:with="n=*{note}"
           th:text="${#strings.isEmpty(n) ? '‚Äî' : n}">‚Äî</div>
    </div>
  </section>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
  <div class="booking-detail-actions">
    <a class="btn btn-gray" th:href="@{/all-bookings}">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>

    <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å : ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß -->
    <button class="btn btn-primary"
            th:if="*{status} != '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' and *{status} != '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'"
            type="button" onclick="openReschedule()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</button>

    <button class="btn btn-green"
            th:if="*{status} != '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' and *{status} != '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'"
            type="button" onclick="markDone()">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>

    <button class="btn btn-red"
            th:if="*{status} != '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' and *{status} != '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'"
            type="button" onclick="cancelBooking()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

    <!-- ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‚Äù ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
    <button class="btn btn-primary"
            th:if="*{status} == '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' and !${isReviewed}"
            type="button" onclick="openReview()">‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>

    <!-- ‡∏ñ‡πâ‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå badge ‡πÅ‡∏ó‡∏ô‡∏õ‡∏∏‡πà‡∏° -->
    <span class="badge badge-ok"
          th:if="*{status} == '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' and ${isReviewed}">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>
  </div>
</main>

<!-- Modal: Reschedule -->
<div id="rsBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="rsTitle">
  <div class="modal">
    <header id="rsTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</header>

    <label for="rsDate">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
    <input id="rsDate" type="date"/>

    <label for="rsTime">‡πÄ‡∏ß‡∏•‡∏≤</label>
    <input id="rsTime" type="time"/>

    <div class="row">
      <button class="btn btn-gray" type="button" onclick="closeReschedule()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" type="button" onclick="submitReschedule()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Modal: Review -->
<div id="rvBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="rvTitle">
  <div class="modal">
    <header id="rvTitle">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</header>
    <div id="rvInfo" class="booking-detail-label" style="margin-bottom:6px">‚Äî</div>

    <div class="stars" role="radiogroup" aria-label="‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≤‡∏ß">
      <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
      <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
      <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
      <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
      <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
    </div>

    <label for="rvComment">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
    <textarea id="rvComment" rows="3" placeholder="‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."
              style="width:100%; border:1px solid var(--border); border-radius:10px; padding:10px"></textarea>

    <div class="row">
      <button class="btn btn-gray" type="button" onclick="closeReview()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" type="button" onclick="submitReview()">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </div>
  </div>
</div>

<!-- Bottom nav (‡πÄ‡∏î‡∏¥‡∏°) -->
<nav class="bottom-nav" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á">
  <a th:href="@{/profile}"><span class="ico">üë§</span><span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></a>
  <a th:href="@{/select_service}"><span class="ico">‚úÇÔ∏è</span><span>‡∏à‡∏≠‡∏á</span></a>
  <a th:href="@{/all-bookings}" class="active"><span class="ico">üìã</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</span></a>
</nav>

<!-- JS -->
<script th:inline="javascript">
  const API_BASE = /*[[@{/api/bookings}]]*/ '/api/bookings';

  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DOM
  const root = document.querySelector('main.booking-detail-wrap');
  const BOOKING_ID = Number(root.dataset.id);

  // CSRF
  const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.content;
  const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

  function headersJSON() {
    const h = { 'Content-Type': 'application/json' };
    if (CSRF_TOKEN && CSRF_HEADER) h[CSRF_HEADER] = CSRF_TOKEN;
    return h;
  }

  /* ---------- ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ---------- */
  async function patchStatus(newStatus){
    try{
      const res = await fetch(`${API_BASE}/${BOOKING_ID}/status`, {
        method:'PATCH',
        headers: headersJSON(),
        body: JSON.stringify({ status: newStatus })
      });
      if(!res.ok){
        const msg = await (async()=>{ try{ return await res.text(); }catch{ return res.status + ' ' + res.statusText; }})();
        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg);
        return;
      }
      location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°/‡∏õ‡πâ‡∏≤‡∏¢
    }catch(err){
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }
  }
  function markDone(){ if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‚Äù?')) patchStatus('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'); }
  function cancelBooking(){ if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) patchStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'); }

  /* ---------- Reschedule ---------- */
  const rsBackdrop = document.getElementById('rsBackdrop');
  const rsDate = document.getElementById('rsDate');
  const rsTime = document.getElementById('rsTime');

  function openReschedule(){
    const d = root.dataset.date; // YYYY-MM-DD
    const t = root.dataset.time; // HH:mm
    if(d) rsDate.value = d;
    if(t) rsTime.value = t.length > 5 ? t.slice(0,5) : t;
    rsBackdrop.style.display = 'flex';
  }
  function closeReschedule(){ rsBackdrop.style.display = 'none'; }

  async function submitReschedule(){
    const d = rsDate.value;
    const t = rsTime.value;
    if(!d || !t){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
    try{
      const res = await fetch(`${API_BASE}/${BOOKING_ID}/time`, {
        method:'PATCH',
        headers: headersJSON(),
        body: JSON.stringify({ date: d, time: t })
      });
      if(!res.ok){
        const msg = await (async()=>{ try{ return await res.text(); }catch{ return res.status + ' ' + res.statusText; }})();
        alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg);
        return;
      }
      closeReschedule();
      location.reload();
    }catch(e){
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }
  }

  // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á / ‡∏Å‡∏î ESC
  rsBackdrop.addEventListener('click', (e)=>{ if(e.target.id === 'rsBackdrop') closeReschedule(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeReschedule(); });

  /* ---------- Review ---------- */
  const POST_REVIEW_URL = /*[[@{/api/reviews}]]*/ '/api/reviews';

  function openReview(){
    const svc = root.dataset.service || '';
    const barber = root.dataset.barber || '';
    document.getElementById('rvInfo').textContent =
      `‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${svc}${barber ? ' ‚Ä¢ ‡∏ä‡πà‡∏≤‡∏á: ' + barber : ''}`;

    document.querySelectorAll('input[name=rating]').forEach(i=>i.checked=false);
    document.getElementById('rvComment').value = '';
    document.getElementById('rvBackdrop').style.display = 'flex';
  }
  function closeReview(){ document.getElementById('rvBackdrop').style.display = 'none'; }

  async function submitReview(){
    const rating = Number(document.querySelector('input[name=rating]:checked')?.value);
    if(!rating){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß'); return; }
    const comment = document.getElementById('rvComment').value.trim();

    const payload = { bookingId: BOOKING_ID, rating, comment };

    try{
      const res = await fetch(POST_REVIEW_URL, {
        method:'POST',
        headers: headersJSON(),
        body: JSON.stringify(payload)
      });
      if(res.ok){
        closeReview();
        // ‡πÅ‡∏ó‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß" ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡πâ‡∏≤‡∏¢ "‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
        const btn = document.querySelector('button[onclick="openReview()"]');
        if(btn){ btn.outerHTML = '<span class="badge badge-ok">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>'; }
        alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß!');
      }else{
        const msg = await (async()=>{ try{ return await res.text(); }catch{ return res.status + " " + res.statusText; }})();
        alert('‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg);
      }
    }catch(e){
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }
  }

  // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á / ‡∏Å‡∏î ESC
  document.getElementById('rvBackdrop').addEventListener('click', (e)=>{
    if(e.target.id === 'rvBackdrop') closeReview();
  });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeReview(); });
</script>
</body>
</html>
